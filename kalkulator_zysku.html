<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poprawiony Kalkulator Rentowności Sprawy</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
            padding: 20px;
        }
        .page-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #374151;
        }
        .logo {
            height: 80px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
        }
        h1 {
            font-size: 2.25rem;
            font-weight: 900;
            margin: 0;
            background-image: linear-gradient(to right, #60a5fa, #34d399);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }
        .grid {
            display: grid;
            gap: 25px;
            grid-template-columns: 1fr;
        }
        @media (min-width: 1100px) {
            .grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        .card {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 10px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .card h3 {
            margin-top: 0;
            color: #60a5fa;
            border-bottom: 1px solid #374151;
            padding-bottom: 15px;
            margin-bottom: 20px;
            font-size: 1.35rem;
            font-weight: 700;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group-slider {
            margin-top: 5px;
        }
        label {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input[type="number"], input[type="range"] {
            width: 100%;
            padding: 10px;
            background-color: #374151;
            border: 1px solid #4b5563;
            border-radius: 6px;
            color: #f9fafb;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input[type="range"] {
            padding: 0;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #4b5563;
            outline: none;
            border-radius: 4px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #34d399;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #34d399;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type="number"]:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.5);
            outline: none;
        }
        input[readonly] {
            background-color: #1a202c;
            color: #9ca3af;
            border-color: #2d3748;
        }
        details {
            border: 1px solid #374151;
            border-radius: 6px;
            padding: 10px;
            margin-top: 15px;
        }
        summary {
            font-weight: 600;
            cursor: pointer;
            color: #9ca3af;
        }
        .tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background-color: #4b5563;
            color: #d1d5db;
            border-radius: 50%;
            font-size: 12px;
            margin-left: 8px;
            cursor: help;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 240px;
            background-color: #111827;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -120px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: 400;
            pointer-events: none;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* --- POPRAWIONE STYLE TABELI --- */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px;
        }
        th, td { 
            padding: 12px 0; 
            text-align: left;
        }
        /* Zastosowanie linii do całych wierszy dla spójności */
        tbody tr {
            border-bottom: 1px solid rgba(75, 85, 99, 0.3);
        }
        /* Usunięcie ostatniej linii w tabeli dla czystego wyglądu */
        tbody tr:last-child {
            border-bottom: none;
        }
        th { 
            color: #9ca3af; 
            font-weight: 500; 
            font-size: 14px; 
            display: flex; 
            align-items: center; 
        }
        thead th {
            display: table-cell;
        }
        td { 
            font-weight: 600; 
            font-size: 16px; 
            color: #f9fafb; 
            text-align: right; 
        }
        .total-row { 
            /* Teraz total-row ma tylko grubą linię na górze, bez dolnej */
            border-top: 2px solid #4b5563;
            font-weight: 700;
        }
        .total-row th, .total-row td { 
            padding-top: 15px; 
            font-size: 17px; 
            color: #f59e0b;
        }
        /* --- KONIEC POPRAWIONYCH STYLI TABELI --- */

        .green-text { color: #34d399; }
        .red-text { color: #ef4444; }
        .action-button { font-size: 16px; width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; margin-top: auto; font-weight: 600; }
        #clear-btn { background-color: #4b5563; color: #e5e7eb; }
        #clear-btn:hover { background-color: #6b7280; }
        .installment-result { background-color: #1a202c; border: 1px dashed #4b5563; border-radius: 8px; padding: 18px; text-align: center; margin-top: 20px; }
        .installment-result .label { font-size: 14px; color: #9ca3af; margin-bottom: 5px; }
        .installment-result .amount { font-size: 24px; font-weight: bold; color: #34d399; }
        
        .radio-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .radio-group label {
            margin: 0;
            padding: 10px;
            background-color: #374151;
            border: 1px solid #4b5563;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            font-weight: 500;
            justify-content: center;
            color: #d1d5db;
        }
        .radio-group input[type="radio"] {
            display: none;
        }
        .radio-group label:hover {
            background-color: #4b5563;
        }
        .radio-group label.selected {
            background-color: #34d399;
            border-color: #34d399;
            color: #111827;
            font-weight: 700;
        }
        .sf-warning {
            display: none;
            font-size: 12px;
            color: #f59e0b;
            text-align: right;
            margin-top: 8px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <header class="page-header">
        <img src="https://daniel-kaf.github.io/narzedzia-skd/logo.png" alt="Logo KAF" class="logo">
        <h1>Kalkulator Rentowności Sprawy</h1>
    </header>

    <div class="container">
        <div class="grid">
            <div class="card">
                <h3>Dane Wejściowe</h3>
                <div class="form-group">
                    <label for="wps">Wartość Przedmiotu Sporu (WPS)</label>
                    <input type="number" id="wps" placeholder="Wpisz kwotę">
                </div>
                <div class="form-group">
                    <label for="caseDuration">Przewidywany czas trwania (miesiące)</label>
                    <input type="number" id="caseDuration" placeholder="Wpisz liczbę miesięcy" value="12">
                </div>
                <div class="form-group">
                    <label for="interestTotal">Całkowite odsetki za opóźnienie</label>
                    <input type="number" id="interestTotal" readonly>
                </div>
                <div class="form-group">
                    <label for="clientShare">Udział Klienta w wygranej (%)</label>
                    <input type="number" id="clientShare" placeholder="Wpisz %" value="50" min="0" max="92">
                    <div class="form-group-slider">
                        <input type="range" id="clientShareSlider" min="0" max="92" value="50">
                    </div>
                    <div class="sf-warning" id="sf-warning">8% to minimalna stawka Success Fee</div>
                </div>
                <div class="form-group">
                    <label for="feeSurplusNet">Opłata KAF (netto)</label>
                    <input type="number" id="feeSurplusNet" placeholder="Wpisz kwotę">
                </div>
                <div class="form-group">
                    <label for="forgivenInterest">Umorzone odsetki dla klienta</label>
                    <input type="number" id="forgivenInterest" placeholder="Wpisz kwotę">
                </div>

                <details>
                    <summary>Ustawienia Zaawansowane</summary>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="vatRate">Stawka VAT (%)</label>
                        <input type="number" id="vatRate" value="23">
                    </div>
                    <div class="form-group">
                        <label for="interestRate">Roczne oprocentowanie odsetek (%)</label>
                        <input type="number" id="interestRate" value="10.5">
                    </div>
                    <div class="form-group">
                        <label for="feeCourt">Opłata sądowa (brutto)</label>
                        <input type="number" id="feeCourt" value="1017">
                    </div>
                    <div class="form-group">
                        <label for="feeMiloszNet">Opłata Miłosza (netto)</label>
                        <input type="number" id="feeMiloszNet" value="2250">
                    </div>
                </details>
                <button id="clear-btn" class="action-button" style="margin-top: 20px;">Wyczyść</button>
            </div>

            <div class="card">
                <h3>Opłaty i Finansowanie</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Opis</th>
                            <th style="text-align:right;">Netto</th>
                            <th style="text-align:right;">Brutto</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><th>Opłata sądowa <div class="tooltip">? <span class="tooltiptext">Stała opłata sądowa. Gdyby miała się zmienić, rozwiń "Ustawienia Zaawansowane".</span></div></th><td id="resCourtNet"></td><td id="resCourtGross"></td></tr>
                        <tr><th>Opłata Miłosza <div class="tooltip">? <span class="tooltiptext">Stała opłata za obsługę prawną. Gdyby miała się zmienić, rozwiń "Ustawienia Zaawansowane".</span></div></th><td id="resMiloszNet"></td><td id="resMiloszGross"></td></tr>
                        <tr><th>Opłata KAF <div class="tooltip">? <span class="tooltiptext">Opłata dla nas.</span></div></th><td id="resSurplusNet"></td><td id="resSurplusGross"></td></tr>
                        <tr class="total-row"><th style="text-align:left;">Razem</th><td id="resTotalNet"></td><td id="resTotalGross"></td></tr>
                    </tbody>
                </table>
                <div class="form-group" style="margin-top: 25px;">
                    <label>Wariant finansowania opłat wstępnych</label>
                    <div class="radio-group">
                        <label><input type="radio" name="financing" value="lump" checked>Jednorazowo</label>
                        <label><input type="radio" name="financing" value="5_installments">5 rat</label>
                        <label><input type="radio" name="financing" value="10_installments">10 rat</label>
                        <label><input type="radio" name="financing" value="20_installments">20 rat</label>
                    </div>
                </div>
                <div class="installment-result">
                    <div class="label" id="installment-label">Opłata jednorazowa</div>
                    <div class="amount" id="installment-amount">0,00 zł</div>
                </div>
            </div>

            <div class="card">
                <h3>Podsumowanie Finansowe</h3>
                <table>
                    <tbody>
                        <tr><th colspan="2" style="color: #60a5fa; padding-bottom:10px; font-size: 1.1em;">Zysk Klienta</th></tr>
                        <tr><th>Zwrot na konto (WPS+Ods.) <div class="tooltip">? <span class="tooltiptext">Suma odzyskanej kwoty głównej (WPS) oraz naliczonych odsetek za opóźnienie.</span></div></th><td class="green-text" id="resCalcReturn"></td></tr>
                        <tr><th>Umorzone odsetki <div class="tooltip">? <span class="tooltiptext">Dodatkowa korzyść dla klienta w postaci długu, który został anulowany.</span></div></th><td class="green-text" id="resCalcForgiven"></td></tr>
                        <tr><th>Zysk brutto <div class="tooltip">? <span class="tooltiptext">Całkowita korzyść klienta przed odliczeniem kosztów. (Zwrot na konto + Umorzone odsetki).</span></div></th><td id="resCalcGrossProfit"></td></tr>
                        <tr><th>Success Fee Kancelarii <div class="tooltip">? <span class="tooltiptext">Wynagrodzenie kancelarii liczone jako procent od całkowitego Zysku brutto.</span></div></th><td class="red-text" id="resCalcSuccessFee"></td></tr>
                        <tr><th>Koszty na start <div class="tooltip">? <span class="tooltiptext">Suma wszystkich opłat wstępnych brutto poniesionych na początku sprawy.</span></div></th><td class="red-text" id="resCalcUpfrontCosts"></td></tr>
                        <tr class="total-row"><th>Zysk klienta na czysto <div class="tooltip">? <span class="tooltiptext">Ostateczna kwota, która zostaje dla klienta po odliczeniu wszystkich kosztów. (Zysk brutto - Success Fee - Koszty na start).</span></div></th><td id="resCalcNetProfit"></td></tr>
                    </tbody>
                </table>
                <table style="margin-top: 30px;">
                     <tbody>
                        <tr><th colspan="2" style="color: #60a5fa; padding-bottom:10px; font-size: 1.1em;">Zysk Kancelarii</th></tr>
                        <tr><th>Prowizja operatora</th><td class="red-text" id="resFirmOperatorFee"></td></tr>
                        <tr><th>Zysk "Na start" (netto)</th><td class="green-text" id="resFirmStartProfit"></td></tr>
                        <tr><th>Success Fee (łączna)</th><td class="green-text" id="resFirmTotalSF"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const ui = {
        wps: document.getElementById('wps'),
        caseDuration: document.getElementById('caseDuration'),
        interestTotal: document.getElementById('interestTotal'),
        clientShare: document.getElementById('clientShare'),
        clientShareSlider: document.getElementById('clientShareSlider'),
        feeSurplusNet: document.getElementById('feeSurplusNet'),
        forgivenInterest: document.getElementById('forgivenInterest'),
        financingOptions: document.querySelectorAll('input[name="financing"]'),
        financingLabels: document.querySelectorAll('.radio-group label'),
        clearBtn: document.getElementById('clear-btn'),
        sfWarning: document.getElementById('sf-warning'),
        vatRate: document.getElementById('vatRate'),
        interestRate: document.getElementById('interestRate'),
        feeCourt: document.getElementById('feeCourt'),
        feeMiloszNet: document.getElementById('feeMiloszNet'),
        resCourtNet: document.getElementById('resCourtNet'),
        resCourtGross: document.getElementById('resCourtGross'),
        resMiloszNet: document.getElementById('resMiloszNet'),
        resMiloszGross: document.getElementById('resMiloszGross'),
        resSurplusNet: document.getElementById('resSurplusNet'),
        resSurplusGross: document.getElementById('resSurplusGross'),
        resTotalNet: document.getElementById('resTotalNet'),
        resTotalGross: document.getElementById('resTotalGross'),
        installmentLabel: document.getElementById('installment-label'),
        installmentAmount: document.getElementById('installment-amount'),
        resCalcReturn: document.getElementById('resCalcReturn'),
        resCalcForgiven: document.getElementById('resCalcForgiven'),
        resCalcGrossProfit: document.getElementById('resCalcGrossProfit'),
        resCalcSuccessFee: document.getElementById('resCalcSuccessFee'),
        resCalcUpfrontCosts: document.getElementById('resCalcUpfrontCosts'),
        resCalcNetProfit: document.getElementById('resCalcNetProfit'),
        resFirmOperatorFee: document.getElementById('resFirmOperatorFee'),
        resFirmStartProfit: document.getElementById('resFirmStartProfit'),
        resFirmTotalSF: document.getElementById('resFirmTotalSF'),
    };
    
    const formatCurrency = (value) => {
        if (typeof value !== 'number' || isNaN(value)) return "0,00 zł";
        return value.toLocaleString('pl-PL', { style: 'currency', currency: 'PLN' });
    };

    const updateFinancingButtons = () => {
        const selectedValue = document.querySelector('input[name="financing"]:checked').value;
        ui.financingLabels.forEach(label => {
            const radio = label.querySelector('input[type="radio"]');
            if (radio.value === selectedValue) label.classList.add('selected');
            else label.classList.remove('selected');
        });
    };
    
    const checkSuccessFeeWarning = () => {
        ui.sfWarning.style.display = ui.clientShare.value == 92 ? 'block' : 'none';
    };

    const calculate = () => {
        const wps = parseFloat(ui.wps.value) || 0;
        const clientSharePercent = (parseFloat(ui.clientShare.value) || 0) / 100;
        const feeSurplusNet = parseFloat(ui.feeSurplusNet.value) || 0;
        const forgivenInterest = parseFloat(ui.forgivenInterest.value) || 0;
        const caseDurationMonths = parseFloat(ui.caseDuration.value) || 0;
        const annualInterestRate = (parseFloat(ui.interestRate.value) || 0) / 100;
        const vatRate = (parseFloat(ui.vatRate.value) || 0) / 100;
        const feeCourt = parseFloat(ui.feeCourt.value) || 0;
        const feeMiloszNet = parseFloat(ui.feeMiloszNet.value) || 0;
        const firmSharePercent = 1 - clientSharePercent;

        const feeMiloszGross = feeMiloszNet * (1 + vatRate);
        const feeSurplusGross = feeSurplusNet * (1 + vatRate);
        const totalFeeNet = feeCourt + feeMiloszNet + feeSurplusNet;
        const totalFeeGross = feeCourt + feeMiloszGross + feeSurplusGross;

        const interestTotal = wps * (annualInterestRate / 12) * caseDurationMonths;
        const totalRecovered = wps + interestTotal;
        const clientGrossProfit = totalRecovered + forgivenInterest;
        
        const totalSuccessFee = clientGrossProfit * firmSharePercent;
        const clientProfitAfterSF = clientGrossProfit - totalSuccessFee;
        const clientNetProfit = clientProfitAfterSF - totalFeeGross;
        
        const financingOption = document.querySelector('input[name="financing"]:checked').value;
        let commissionRate = 0;
        if (financingOption === '5_installments' || financingOption === '10_installments') commissionRate = 0.0449;
        else if (financingOption === '20_installments') commissionRate = 0.0699;
        const operatorFee = totalFeeGross * commissionRate;
        const firmStartProfit = feeSurplusNet - operatorFee;
        
        let numInstallments = 1;
        let installmentLabel = "Opłata jednorazowa";
        if (financingOption === '5_installments') { numInstallments = 5; installmentLabel = "Miesięczna rata (5 x 0%)"; } 
        else if (financingOption === '10_installments') { numInstallments = 10; installmentLabel = "Miesięczna rata (10 x 0%)"; } 
        else if (financingOption === '20_installments') { numInstallments = 20; installmentLabel = "Miesięczna rata (20 x 0%)"; }
        const installmentAmount = totalFeeGross / numInstallments;
        
        ui.interestTotal.value = interestTotal.toFixed(2);
        ui.resCourtNet.textContent = formatCurrency(feeCourt);
        ui.resCourtGross.textContent = formatCurrency(feeCourt);
        ui.resMiloszNet.textContent = formatCurrency(feeMiloszNet);
        ui.resMiloszGross.textContent = formatCurrency(feeMiloszGross);
        ui.resSurplusNet.textContent = formatCurrency(feeSurplusNet);
        ui.resSurplusGross.textContent = formatCurrency(feeSurplusGross);
        ui.resTotalNet.textContent = formatCurrency(totalFeeNet);
        ui.resTotalGross.textContent = formatCurrency(totalFeeGross);
        ui.installmentLabel.textContent = installmentLabel;
        ui.installmentAmount.textContent = formatCurrency(installmentAmount);
        
        ui.resCalcReturn.textContent = formatCurrency(totalRecovered);
        ui.resCalcForgiven.textContent = formatCurrency(forgivenInterest);
        ui.resCalcGrossProfit.textContent = formatCurrency(clientGrossProfit);
        ui.resCalcSuccessFee.textContent = formatCurrency(-totalSuccessFee);
        ui.resCalcUpfrontCosts.textContent = formatCurrency(-totalFeeGross);
        ui.resCalcNetProfit.textContent = formatCurrency(clientNetProfit);
        
        ui.resFirmOperatorFee.textContent = formatCurrency(operatorFee);
        ui.resFirmStartProfit.textContent = formatCurrency(firmStartProfit);
        ui.resFirmTotalSF.textContent = formatCurrency(totalSuccessFee);
        
        updateFinancingButtons();
        checkSuccessFeeWarning();
        saveData();
    };
    
    const clearForm = () => {
        Object.values(ui).forEach(element => {
            if (element && element.nodeName === 'INPUT' && element.type !== 'radio') {
                element.value = '';
            }
        });
        ui.clientShare.value = '50';
        ui.clientShareSlider.value = '50';
        ui.vatRate.value = '23';
        ui.interestRate.value = '10.5';
        ui.feeCourt.value = '1017';
        ui.feeMiloszNet.value = '2250';
        ui.caseDuration.value = '12';
        document.querySelector('input[name="financing"][value="lump"]').checked = true;
        localStorage.removeItem('kalkulatorData');
        calculate();
    };

    const saveData = () => {
        const data = {
            wps: ui.wps.value, caseDuration: ui.caseDuration.value, clientShare: ui.clientShare.value,
            feeSurplusNet: ui.feeSurplusNet.value, forgivenInterest: ui.forgivenInterest.value,
            financing: document.querySelector('input[name="financing"]:checked').value,
            vatRate: ui.vatRate.value, interestRate: ui.interestRate.value,
            feeCourt: ui.feeCourt.value, feeMiloszNet: ui.feeMiloszNet.value,
        };
        localStorage.setItem('kalkulatorData', JSON.stringify(data));
    };

    const loadData = () => {
        const data = JSON.parse(localStorage.getItem('kalkulatorData'));
        if (data) {
            ui.wps.value = data.wps || '50000';
            ui.caseDuration.value = data.caseDuration || '12';
            ui.clientShare.value = data.clientShare || '50';
            ui.clientShareSlider.value = data.clientShare || '50';
            ui.feeSurplusNet.value = data.feeSurplusNet || '';
            ui.forgivenInterest.value = data.forgivenInterest || '';
            ui.vatRate.value = data.vatRate || '23';
            ui.interestRate.value = data.interestRate || '10.5';
            ui.feeCourt.value = data.feeCourt || '1017';
            ui.feeMiloszNet.value = data.feeMiloszNet || '2250';
            if (data.financing) {
                document.querySelector(`input[name="financing"][value="${data.financing}"]`).checked = true;
            }
        }
    };

    const inputs = [
        ui.wps, ui.caseDuration, ui.clientShare, ui.feeSurplusNet, ui.forgivenInterest,
        ui.vatRate, ui.interestRate, ui.feeCourt, ui.feeMiloszNet
    ];
    inputs.forEach(input => input.addEventListener('input', calculate));
    ui.financingOptions.forEach(radio => radio.addEventListener('change', calculate));
    ui.clientShareSlider.addEventListener('input', (e) => { ui.clientShare.value = e.target.value; calculate(); });
    ui.clientShare.addEventListener('input', (e) => { ui.clientShareSlider.value = e.target.value; });
    ui.clearBtn.addEventListener('click', clearForm);

    loadData();
    calculate();
});
</script>

</body>
</html>
