<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator WPS - Wykres i Scenariusze</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        
        :root {
            --bg-color: #111827;
            --container-bg: #1f2937;
            --input-group-bg: #374151;
            --input-bg: #4b5563;
            --text-primary: #d1d5db;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --input-border: #6b7280;
            --accent-green: #34d399;
            --accent-blue: #60a5fa;
            --accent-yellow: #f59e0b;
            --error-color: #f87171;
            --shadow-color: rgba(0,0,0,0.4);
            --logo-border: rgba(255,255,255,0.1);
        }

        body.light-mode {
            --bg-color: #f9fafb;
            --container-bg: #ffffff;
            --input-group-bg: #f3f4f6;
            --input-bg: #e5e7eb;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --input-border: #d1d5db;
            --shadow-color: rgba(0,0,0,0.1);
            --logo-border: rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .header-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin-bottom: 30px;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        .logo {
            height: 80px;
            border-radius: 8px;
            box-shadow: 0 5px 15px var(--shadow-color);
            border: 1px solid var(--logo-border);
        }
        h2 {
            text-align: left;
            margin: 0;
            font-weight: 900;
            font-size: 2.25rem;
            background-image: linear-gradient(to right, var(--accent-blue), var(--accent-green));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .theme-switcher {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch input { display: none; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--input-bg);
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: #fff;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent-green); }
        input:checked + .slider:before { transform: translateX(20px); }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }
        .input-section, .results-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .input-group {
            background-color: var(--input-group-bg);
            padding: 10px 15px;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        .input-group label {
            display: block;
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            background-color: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        button { cursor: pointer; font-weight: 500;}
        button:hover {
             filter: brightness(1.1);
        }
        input.input-error { border-color: var(--error-color); }
        .error-message { color: var(--error-color); font-size: 12px; margin-top: 5px; }
        
        .checkbox-group { display: flex; align-items: center; gap: 10px; padding: 10px 15px; }
        .checkbox-group label { margin-bottom: 0; color: var(--text-primary); }
        input[type="checkbox"] { width: 1.2em; height: 1.2em; accent-color: var(--accent-green); }
        
        .collapsible {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out, padding 0.5s ease-out, opacity 0.3s ease-out;
            opacity: 0;
            padding: 0 10px;
        }
        .collapsible.visible { max-height: 100px; opacity: 1; padding: 0; }

        #overpayments-container .input-group { display: flex; gap: 10px; align-items: center; }
        #overpayments-container .input-group > div { flex-grow: 1; }
        .remove-btn {
            background: none; border: none; color: var(--error-color);
            font-size: 24px; cursor: pointer; padding: 0 5px; width: auto;
        }
        .add-btn {
            background-color: var(--input-group-bg); border: 1px dashed var(--input-border);
            color: var(--text-secondary);
        }
        .add-btn:hover { background-color: var(--input-bg); color: var(--text-primary); }

        .results-section { gap: 12px; }
        .result-box {
            background-color: var(--input-group-bg);
            padding: 15px 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--input-bg);
            gap: 20px;
        }
        .result-label-group { display: flex; align-items: center; gap: 8px; position: relative; }
        .result-label { font-size: 14px; color: var(--text-secondary); text-transform: uppercase; font-weight: 500; margin: 0; line-height: 1.3; }
        .tooltip-icon { font-size: 16px; color: var(--text-secondary); cursor: help; }
        .tooltip-text {
            visibility: hidden; width: 220px; background-color: var(--bg-color); color: var(--text-primary);
            text-align: center; border-radius: 6px; padding: 8px; position: absolute;
            z-index: 10; bottom: 125%; left: 50%; margin-left: -110px;
            opacity: 0; transition: opacity 0.3s; border: 1px solid var(--border-color);
            box-shadow: 0 5px 15px var(--shadow-color); font-size: 12px; text-transform: none;
        }
        .result-label-group:hover .tooltip-text { visibility: visible; opacity: 1; }
        .result-value { font-size: 26px; font-weight: 600; margin: 0; text-align: right; flex-shrink: 0; }
        .result-box.wps-highlight { border-left-color: var(--accent-green); }
        .result-value.wps-value { color: var(--accent-green); font-weight: 700; font-size: 28px; }
        .result-value.secondary-value { color: var(--text-secondary); font-weight: 500; }
        
        .scenario-manager {
            background-color: var(--input-group-bg);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 30px; 
        }
        .scenario-manager .actions, .scenario-manager .backup-actions {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        .scenario-manager input[type="text"] {
            margin-bottom: 5px;
        }
        .scenario-manager select { flex-grow: 1; }
        .scenario-manager button, .info-btn { 
            width: auto; 
            padding: 10px 15px;
        }
        
        #saveScenarioBtn { 
            background-color: var(--accent-green); 
            border-color: var(--accent-green); 
            color: #fff;
            flex-grow: 2;
        }
        #deleteScenarioBtn { 
            background-color: var(--error-color); 
            border-color: var(--error-color); 
            color: #fff;
            flex-grow: 1;
        }
        #exportScenariosBtn, #importScenariosBtn { 
            background-color: var(--input-bg); 
            border-color: var(--input-border); 
            color: var(--text-secondary); 
            flex-grow: 1;
        }
        
        .info-btn {
            position: relative;
            background-color: var(--accent-yellow) !important;
            border-color: var(--accent-yellow) !important;
            color: #fff !important;
            flex-grow: 1;
            /* DODANO: Wy≈õrodkowanie zawarto≈õci */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .info-btn .tooltip-text {
            width: 280px;
            left: auto;
            right: 0;
            margin-left: 0;
            text-align: left;
            line-height: 1.4;
        }
        .info-btn:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .chart-container {
            grid-column: 1 / -1;
            margin-top: 20px;
            padding: 20px;
            background-color: var(--input-group-bg);
            border-radius: 8px;
        }

        #undo-toast {
            visibility: hidden;
            min-width: 250px;
            background-color: var(--input-group-bg);
            color: var(--text-primary);
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px;
            font-size: 16px;
            box-shadow: 0 5px 20px var(--shadow-color);
            display: flex;
            align-items: center;
            gap: 15px;
            opacity: 0;
            transition: visibility 0.5s, opacity 0.5s, bottom 0.5s;
        }
        #undo-toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
        #undo-toast button {
            width: auto;
            padding: 8px 12px;
            font-weight: bold;
            background-color: var(--accent-blue);
            border-color: var(--accent-blue);
            color: #fff;
        }

        @media (max-width: 800px) {
            .main-grid { grid-template-columns: 1fr; }
            .result-box { flex-direction: column; align-items: flex-start; gap: 5px; }
            .result-value { text-align: left; }
            .header-container { flex-direction: column; }
            .theme-switcher { position: static; margin-top: 15px; }
            .scenario-manager .actions { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="header-container">
        <header class="page-header">
            <img src="https://daniel-kaf.github.io/narzedzia-skd/logo.png" alt="Logo KAF" class="logo">
            <h2>Kalkulator WPS</h2>
        </header>
        <div class="theme-switcher">
            <span>‚òÄÔ∏è</span>
            <label class="switch">
                <input type="checkbox" id="themeToggle">
                <span class="slider"></span>
            </label>
            <span>üåô</span>
        </div>
    </div>
    <div class="container">
        <div class="main-grid">
            <div class="input-section">
                <div class="input-group">
                    <label for="kwotaKredytu">Kwota kredytu (tylko kapita≈Ç)</label>
                    <input type="number" id="kwotaKredytu" oninput="calculateWPS()">
                </div>
                <div class="input-group">
                    <label for="prowizja">Prowizja w umowie (kwotowo)</label>
                    <input type="number" id="prowizja" oninput="calculateWPS()">
                </div>
                <div class="input-group">
                    <label for="marza">Mar≈ºa banku (%)</label>
                    <input type="number" id="marza" step="0.01" oninput="calculateWPS()">
                </div>
                <div class="input-group">
                    <label for="okresSplaty">Okres sp≈Çaty (msc)</label>
                    <input type="number" id="okresSplaty" oninput="calculateWPS()">
                </div>
                <div class="input-group">
                    <label for="dataPodpisania">Data podpisania umowy</label>
                    <input type="date" id="dataPodpisania" oninput="calculateWPS()">
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="czySplacona">
                    <label for="czySplacona">Czy umowa zosta≈Ça sp≈Çacona w ca≈Ço≈õci?</label>
                </div>
                <div id="poleDataZakonczeniaWrapper" class="collapsible">
                    <div class="input-group">
                        <label for="dataZakonczenia">Data sp≈Çaty kredytu</label>
                        <input type="date" id="dataZakonczenia" oninput="calculateWPS()">
                        <p class="error-message" id="date-error" style="display: none;"></p>
                    </div>
                </div>
                
                <div id="poleDataSymulacji" class="input-group">
                    <label for="dataSymulacji">Data dzisiejsza</label>
                    <input type="date" id="dataSymulacji" oninput="calculateWPS()">
                </div>

                <div id="overpayments-container"></div>
                <button id="addOverpaymentBtn" class="add-btn">‚ûï Dodaj nadp≈Çatƒô</button>
            </div>

            <div class="results-section">
                <div class="result-box wps-highlight">
                    <div class="result-label-group">
                        <p class="result-label">WPS</p>
                        <span class="tooltip-icon">‚ùì</span>
                        <span class="tooltip-text">Warto≈õƒá Przedmiotu Sporu. Suma zap≈Çaconych odsetek i prowizji (lub jej proporcjonalnej czƒô≈õci w przypadku sp≈Çaty).</span>
                    </div>
                    <p class="result-value wps-value" id="wynikWpsWTrakcie">0,00 z≈Ç</p>
                </div>
                <div class="result-box">
                    <div class="result-label-group">
                        <p class="result-label">Odsetki pozosta≈Çe</p>
                        <span class="tooltip-icon">‚ùì</span>
                        <span class="tooltip-text">Prognozowana suma odsetek do zap≈Çaty do ko≈Ñca umowy przy obecnym oprocentowaniu.</span>
                    </div>
                    <p class="result-value secondary-value" id="wynikUmorzoneOdsetki">0,00 z≈Ç</p>
                </div>
                 <div class="result-box">
                    <div class="result-label-group">
                        <p class="result-label">Odsetki ca≈Çkowite</p>
                        <span class="tooltip-icon">‚ùì</span>
                        <span class="tooltip-text">Teoretyczna suma odsetek na ca≈Çy okres kredytu, liczona wg oprocentowania z dnia umowy.</span>
                    </div>
                    <p class="result-value secondary-value" id="wynikOdsetkiCalkowite">0,00 z≈Ç</p>
                </div>
                
                <div class="scenario-manager">
                    <input type="text" id="scenarioSearch" placeholder="Filtruj scenariusze...">
                    <select id="scenariosDropdown"></select>
                    <div class="actions">
                        <button id="saveScenarioBtn">üíæ Zapisz</button>
                        <button id="deleteScenarioBtn">üóëÔ∏è Usu≈Ñ</button>
                        <div class="info-btn">‚ö†Ô∏è Wa≈ºne!
                            <span class="tooltip-text">Scenariusze sƒÖ zapisywane w pamiƒôci lokalnej Twojej przeglƒÖdarki (localStorage). Nie zostanƒÖ usuniƒôte przez standardowe czyszczenie ciasteczek, ale zniknƒÖ, je≈õli wyczy≈õcisz "dane witryn" dla tej strony.</span>
                        </div>
                    </div>
                    <div class="backup-actions">
                        <button id="exportScenariosBtn">Eksportuj</button>
                        <button id="importScenariosBtn">Importuj</button>
                        <input type="file" id="importFileInput" style="display: none;" accept=".json">
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="capitalChart"></canvas>
            </div>
        </div>
    </div>

    <div id="undo-toast">
        <span id="undo-message"></span>
        <button id="undo-btn">Cofnij</button>
    </div>
</div>

<script>
    // --- BAZA DANYCH WIBOR ---
    const wibor3mHistory = {
        '2025-07-01': 5.80, '2025-04-01': 5.80, '2025-01-01': 5.82,
        '2024-10-01': 5.84, '2024-07-01': 5.86, '2024-04-01': 5.87, '2024-01-01': 5.88,
        '2023-10-01': 5.65, '2023-07-01': 6.90, '2023-04-01': 6.90, '2023-01-01': 6.99,
        '2022-10-01': 7.15, '2022-07-01': 7.00, '2022-04-01': 5.27, '2022-01-01': 2.55,
        '2021-10-01': 0.69, '2021-07-01': 0.22, '2021-04-01': 0.21, '2021-01-01': 0.21,
        '2020-10-01': 0.22, '2020-07-01': 0.23, '2020-04-01': 0.71, '2020-01-01': 1.71,
    };

    const formatCurrency = (value) => (value || 0).toLocaleString('pl-PL', { style: 'currency', currency: 'PLN' });
    const getValue = (id) => parseFloat(document.getElementById(id).value) || 0;
    let capitalChart = null; 

    // --- UNDO DELETE ---
    let recentlyDeleted = null;
    let undoTimeout = null;

    function getWiborForDate(date) {
        let closestDate = null;
        for (const wiborDateStr in wibor3mHistory) {
            const wiborDate = new Date(wiborDateStr);
            if (wiborDate <= date && (!closestDate || wiborDate > closestDate)) {
                closestDate = wiborDate;
            }
        }
        return closestDate ? wibor3mHistory[closestDate.toISOString().split('T')[0]] : 0;
    }
    
    function validateDates(startDateStr, endDateStr) {
        const errorMsg = document.getElementById('date-error');
        const endDateInput = document.getElementById('dataZakonczenia');
        if (!startDateStr || !endDateStr) {
            errorMsg.style.display = 'none';
            endDateInput.classList.remove('input-error');
            return true;
        }
        const startDate = new Date(startDateStr);
        const endDate = new Date(endDateStr);
        if (endDate < startDate) {
            errorMsg.textContent = 'Data sp≈Çaty nie mo≈ºe byƒá wcze≈õniejsza ni≈º data podpisania.';
            errorMsg.style.display = 'block';
            endDateInput.classList.add('input-error');
            return false;
        } else {
            errorMsg.style.display = 'none';
            endDateInput.classList.remove('input-error');
            return true;
        }
    }

    function updateChart(labels, capitalData, interestData) {
        const ctx = document.getElementById('capitalChart').getContext('2d');
        const isDarkMode = !document.body.classList.contains('light-mode');
        const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const textColor = isDarkMode ? '#d1d5db' : '#1f2937';

        if (capitalChart) {
            capitalChart.destroy();
        }
        capitalChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    type: 'line',
                    label: 'Pozosta≈Çy kapita≈Ç',
                    data: capitalData,
                    borderColor: 'rgb(52, 211, 153)',
                    backgroundColor: 'rgba(52, 211, 153, 0.1)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0,
                    yAxisID: 'yCapital',
                },{
                    type: 'bar',
                    label: 'Miesiƒôczne odsetki',
                    data: interestData,
                    backgroundColor: 'rgba(96, 165, 250, 0.5)',
                    borderColor: 'rgb(96, 165, 250)',
                    yAxisID: 'yInterest',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    yCapital: { 
                        type: 'linear',
                        position: 'left',
                        beginAtZero: true,
                        ticks: { color: textColor },
                        grid: { color: gridColor },
                        title: { display: true, text: 'Kapita≈Ç (PLN)', color: textColor }
                    },
                    yInterest: {
                        type: 'linear',
                        position: 'right',
                        beginAtZero: true,
                        ticks: { color: textColor },
                        grid: { drawOnChartArea: false },
                        title: { display: true, text: 'Odsetki (PLN)', color: textColor }
                    },
                    x: {
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: textColor }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                }
            }
        });
    }

    function calculateWPS() {
        const P_base = getValue('kwotaKredytu');
        const prowizja = getValue('prowizja');
        const marza = getValue('marza');
        const n_total = getValue('okresSplaty');
        const P_financed = P_base + prowizja;
        const dataPodpisaniaStr = document.getElementById('dataPodpisania').value;
        const isPaidOff = document.getElementById('czySplacona').checked;
        const dataZakonczeniaStr = document.getElementById('dataZakonczenia').value;
        const dataSymulacjiStr = document.getElementById('dataSymulacji').value;

        if (isPaidOff && !validateDates(dataPodpisaniaStr, dataZakonczeniaStr)) return;

        let effectiveEndDateStr = isPaidOff ? dataZakonczeniaStr : dataSymulacjiStr;

        if (!dataPodpisaniaStr || !effectiveEndDateStr) return;

        const overpayments = [];
        document.querySelectorAll('.overpayment-item').forEach(item => {
            const date = item.querySelector('input[type="date"]').value;
            const amount = parseFloat(item.querySelector('input[type="number"]').value) || 0;
            if (date && amount > 0) overpayments.push({ date: new Date(date), amount });
        });
        overpayments.sort((a, b) => a.date - b.date);
        
        const dataPodpisania = new Date(dataPodpisaniaStr);
        const effectiveEndDate = new Date(effectiveEndDateStr);
        
        let pozostalyKapital = P_financed;
        let sumaRzeczywistychOdsetek = 0;
        let currentDate = new Date(dataPodpisania);
        let miesiaceSplacone = 0;
        
        const chartLabels = [dataPodpisania.toLocaleDateString('sv')];
        const chartCapitalData = [pozostalyKapital];
        const chartInterestData = [0];

        if (P_financed > 0) {
            while(currentDate < effectiveEndDate && miesiaceSplacone < n_total) {
                overpayments.forEach(op => {
                    if (op.date.getFullYear() === currentDate.getFullYear() && op.date.getMonth() === currentDate.getMonth()) {
                        pozostalyKapital -= op.amount;
                    }
                });

                const wibor = getWiborForDate(currentDate);
                const rocznaStopa = marza + wibor;
                const r_miesieczna = (rocznaStopa / 100) / 12;
                const odsetkiWMiesiacu = pozostalyKapital * r_miesieczna;
                sumaRzeczywistychOdsetek += odsetkiWMiesiacu;

                const n_pozostalo_w_petli = n_total - miesiaceSplacone;
                let rataMiesieczna = 0;
                if (pozostalyKapital > 0 && n_pozostalo_w_petli > 0 && r_miesieczna > 0) {
                    rataMiesieczna = pozostalyKapital * (r_miesieczna * Math.pow(1 + r_miesieczna, n_pozostalo_w_petli)) / (Math.pow(1 + r_miesieczna, n_pozostalo_w_petli) - 1);
                } else if (pozostalyKapital > 0 && n_pozostalo_w_petli > 0) {
                    rataMiesieczna = pozostalyKapital / n_pozostalo_w_petli;
                }
                const splataKapitalu = rataMiesieczna - odsetkiWMiesiacu;
                pozostalyKapital -= splataKapitalu;
                
                currentDate.setMonth(currentDate.getMonth() + 1);
                miesiaceSplacone++;
                
                chartLabels.push(currentDate.toLocaleDateString('sv'));
                chartCapitalData.push(Math.max(0, pozostalyKapital));
                chartInterestData.push(odsetkiWMiesiacu);
            }
        }
        pozostalyKapital = Math.max(0, pozostalyKapital);
        
        let wpsWTrakcie = 0;
        let odsetkiPozostale = 0;
        
        if (isPaidOff) {
            const miesiaceOszczedzone = n_total > 0 ? n_total - miesiaceSplacone : 0;
            const zwrotProwizji = n_total > 0 ? (prowizja / n_total) * miesiaceOszczedzone : 0;
            const faktycznyKosztProwizji = prowizja - zwrotProwizji;
            wpsWTrakcie = faktycznyKosztProwizji + sumaRzeczywistychOdsetek;
            odsetkiPozostale = 0;
        } else {
            wpsWTrakcie = prowizja + sumaRzeczywistychOdsetek;
            const n_pozostalo = n_total - miesiaceSplacone;
            if (pozostalyKapital > 0 && n_pozostalo > 0) {
                const wiborPrzyszly = getWiborForDate(effectiveEndDate);
                const przyszlaRocznaStopa = marza + wiborPrzyszly;
                const r_przyszle_miesieczne = (przyszlaRocznaStopa / 100) / 12;
                if (r_przyszle_miesieczne >= 0) {
                    let tempCapital = pozostalyKapital;
                    for (let i = 0; i < n_pozostalo; i++) {
                        const n_rat_do_konca = n_pozostalo - i;
                        const pmt_przyszle = (tempCapital > 0 && r_przyszle_miesieczne > 0) ? tempCapital * (r_przyszle_miesieczne * Math.pow(1 + r_przyszle_miesieczne, n_rat_do_konca)) / (Math.pow(1 + r_przyszle_miesieczne, n_rat_do_konca) - 1) : (tempCapital / n_rat_do_konca);
                        const futureInterest = tempCapital * r_przyszle_miesieczne;
                        odsetkiPozostale += futureInterest;
                        tempCapital -= (pmt_przyszle - futureInterest);
                        
                        let futureDate = new Date(effectiveEndDate);
                        futureDate.setMonth(futureDate.getMonth() + i + 1);
                        chartLabels.push(futureDate.toLocaleDateString('sv'));
                        chartCapitalData.push(Math.max(0, tempCapital));
                        chartInterestData.push(futureInterest);
                    }
                }
            }
        }
        
        const umowneOprocentowanie = marza + getWiborForDate(dataPodpisania);
        const r_umowne = (umowneOprocentowanie / 100) / 12;
        let odsetkiCalkowiteWgUmowy = 0;
        if (P_financed > 0 && n_total > 0 && r_umowne > 0) {
            const pmt_umowne = P_financed * (r_umowne * Math.pow(1 + r_umowne, n_total)) / (Math.pow(1 + r_umowne, n_total) - 1);
            odsetkiCalkowiteWgUmowy = (pmt_umowne * n_total) - P_financed;
        }
        
        document.getElementById('wynikWpsWTrakcie').textContent = formatCurrency(wpsWTrakcie);
        document.getElementById('wynikUmorzoneOdsetki').textContent = formatCurrency(odsetkiPozostale);
        document.getElementById('wynikOdsetkiCalkowite').textContent = formatCurrency(odsetkiCalkowiteWgUmowy);
        updateChart(chartLabels, chartCapitalData, chartInterestData);
    }
    
    // --- Scenario Management ---
    const SCENARIOS_KEY = 'wpsCalculatorScenarios';

    function getScenarios() {
        return JSON.parse(localStorage.getItem(SCENARIOS_KEY)) || [];
    }

    function saveScenarios(scenarios) {
        localStorage.setItem(SCENARIOS_KEY, JSON.stringify(scenarios));
    }

    function populateScenariosDropdown(excludeName = null) {
        const scenarios = getScenarios().filter(s => !excludeName || s.name !== excludeName);
        scenarios.sort((a, b) => a.name.localeCompare(b.name, 'pl', { sensitivity: 'base' }));

        const dropdown = document.getElementById('scenariosDropdown');
        const currentValue = dropdown.value;
        dropdown.innerHTML = '<option value="">Wczytaj scenariusz...</option>';
        scenarios.forEach(s => {
            const option = document.createElement('option');
            option.value = s.name;
            option.textContent = s.name;
            dropdown.appendChild(option);
        });
        dropdown.value = currentValue;
    }

    function collectFormData(name) {
        const overpayments = [];
        document.querySelectorAll('.overpayment-item').forEach(item => {
            overpayments.push({
                amount: item.querySelector('input[type="number"]').value,
                date: item.querySelector('input[type="date"]').value
            });
        });
        return {
            name: name,
            kwotaKredytu: document.getElementById('kwotaKredytu').value,
            prowizja: document.getElementById('prowizja').value,
            marza: document.getElementById('marza').value,
            okresSplaty: document.getElementById('okresSplaty').value,
            dataPodpisania: document.getElementById('dataPodpisania').value,
            czySplacona: document.getElementById('czySplacona').checked,
            dataZakonczenia: document.getElementById('dataZakonczenia').value,
            dataSymulacji: document.getElementById('dataSymulacji').value,
            overpayments: overpayments
        };
    }

    function applyScenario(scenario) {
        document.getElementById('kwotaKredytu').value = scenario.kwotaKredytu;
        document.getElementById('prowizja').value = scenario.prowizja;
        document.getElementById('marza').value = scenario.marza;
        document.getElementById('okresSplaty').value = scenario.okresSplaty;
        document.getElementById('dataPodpisania').value = scenario.dataPodpisania;
        document.getElementById('czySplacona').checked = scenario.czySplacona;
        document.getElementById('dataZakonczenia').value = scenario.dataZakonczenia;
        document.getElementById('dataSymulacji').value = scenario.dataSymulacji;

        const container = document.getElementById('overpayments-container');
        container.innerHTML = '';
        if(scenario.overpayments) {
            scenario.overpayments.forEach(op => {
                addOverpaymentRow(op.amount, op.date);
            });
        }
        
        document.getElementById('czySplacona').dispatchEvent(new Event('change'));
        calculateWPS();
    }
    
    function addOverpaymentRow(amount = '', date = '') {
        const container = document.getElementById('overpayments-container');
        const newOverpayment = document.createElement('div');
        newOverpayment.className = 'input-group overpayment-item';
        newOverpayment.innerHTML = `
            <div><label>Kwota nadp≈Çaty</label><input type="number" value="${amount}" oninput="calculateWPS()"></div>
            <div><label>Data nadp≈Çaty</label><input type="date" value="${date}" oninput="calculateWPS()"></div>
            <button class="remove-btn">‚ùå</button>
        `;
        container.appendChild(newOverpayment);
        newOverpayment.querySelector('.remove-btn').addEventListener('click', function() {
            this.parentElement.remove();
            calculateWPS();
        });
    }

    function exportScenarios() {
        const scenarios = getScenarios();
        if (scenarios.length === 0) {
            alert("Brak scenariuszy do wyeksportowania.");
            return;
        }
        const dataStr = JSON.stringify(scenarios, null, 2);
        const dataBlob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'scenariusze-wps.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const scenarios = JSON.parse(e.target.result);
                if (Array.isArray(scenarios) && scenarios.every(s => 'name' in s)) {
                    if (confirm("Zaimportowanie scenariuszy nadpisze wszystkie obecne. Czy kontynuowaƒá?")) {
                        saveScenarios(scenarios);
                        populateScenariosDropdown();
                        alert(`Zaimportowano pomy≈õlnie ${scenarios.length} scenariuszy.`);
                    }
                } else {
                    throw new Error("Nieprawid≈Çowy format pliku.");
                }
            } catch (error) {
                alert("B≈ÇƒÖd podczas importowania pliku. Upewnij siƒô, ≈ºe plik jest prawid≈Çowy.");
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    // --- Event Listeners and Initial Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        const themeToggle = document.getElementById('themeToggle');
        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light-mode');
            themeToggle.checked = false;
        } else {
            themeToggle.checked = true;
        }
        themeToggle.addEventListener('change', () => {
            document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
            calculateWPS();
        });

        document.getElementById('czySplacona').addEventListener('change', function() {
            const wrapper = document.getElementById('poleDataZakonczeniaWrapper');
            const poleDataSymulacji = document.getElementById('poleDataSymulacji');
            if (this.checked) {
                wrapper.classList.add('visible');
                poleDataSymulacji.style.display = 'none';
            } else {
                wrapper.classList.remove('visible');
                poleDataSymulacji.style.display = 'block';
            }
            calculateWPS();
        });

        document.getElementById('addOverpaymentBtn').addEventListener('click', () => addOverpaymentRow());

        document.getElementById('saveScenarioBtn').addEventListener('click', () => {
            const name = prompt("Podaj nazwƒô dla zapisu scenariusza:", "");
            if (name && name.trim() !== '') {
                const scenarios = getScenarios();
                if (scenarios.some(s => s.name === name.trim())) {
                    if (!confirm(`Scenariusz o nazwie "${name.trim()}" ju≈º istnieje. Czy chcesz go nadpisaƒá?`)) {
                        return;
                    }
                }
                const data = collectFormData(name.trim());
                saveScenarios(scenarios.filter(s => s.name !== name.trim()).concat(data));
                populateScenariosDropdown();
                document.getElementById('scenariosDropdown').value = name.trim();
                alert(`Scenariusz "${name.trim()}" zosta≈Ç zapisany!`);
            }
        });
        
        document.getElementById('scenariosDropdown').addEventListener('change', function() {
            if (!this.value) return;
            const scenario = getScenarios().find(s => s.name === this.value);
            if (scenario) applyScenario(scenario);
        });

        document.getElementById('deleteScenarioBtn').addEventListener('click', () => {
            const dropdown = document.getElementById('scenariosDropdown');
            const name = dropdown.value;
            if (!name) return;
            if (confirm(`Czy na pewno chcesz usunƒÖƒá scenariusz "${name}"?`)) {
                const scenarios = getScenarios();
                recentlyDeleted = scenarios.find(s => s.name === name);
                const updatedScenarios = scenarios.filter(s => s.name !== name);
                saveScenarios(updatedScenarios);
                populateScenariosDropdown();
                
                const toast = document.getElementById('undo-toast');
                document.getElementById('undo-message').textContent = `Usuniƒôto "${name}".`;
                toast.classList.add('show');
                clearTimeout(undoTimeout);
                undoTimeout = setTimeout(() => {
                    toast.classList.remove('show');
                    recentlyDeleted = null;
                }, 7000);
            }
        });
        
        document.getElementById('undo-btn').addEventListener('click', () => {
            if (recentlyDeleted) {
                const scenarios = getScenarios();
                scenarios.push(recentlyDeleted);
                saveScenarios(scenarios);
                populateScenariosDropdown();
                document.getElementById('scenariosDropdown').value = recentlyDeleted.name;
                
                recentlyDeleted = null;
                clearTimeout(undoTimeout);
                document.getElementById('undo-toast').classList.remove('show');
            }
        });
        
        document.getElementById('scenarioSearch').addEventListener('input', function() {
            const filter = this.value.toLowerCase();
            const options = document.querySelectorAll('#scenariosDropdown option');
            options.forEach(option => {
                if(option.value === "") return;
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(filter) ? '' : 'none';
            });
        });
        
        document.getElementById('exportScenariosBtn').addEventListener('click', exportScenarios);
        document.getElementById('importScenariosBtn').addEventListener('click', () => document.getElementById('importFileInput').click());
        document.getElementById('importFileInput').addEventListener('change', handleFileImport);

        document.getElementById('dataSymulacji').value = new Date().toISOString().split('T')[0];
        populateScenariosDropdown();
        calculateWPS();
    });
</script>
</body>
</html>
